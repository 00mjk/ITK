#!/bin/sh
# Dummy line to execute tclsh or wish as needed. \
exec tclsh "$0" ${1+"$@"}

# =========================================================================
# 
#   Program:   Insight Segmentation & Registration Toolkit
#   Module:    Configure.tcl.in
#   Language:  Tcl
#   Date:      $Date$
#   Version:   $Revision$
# 

# Copyright (c) 2001 Insight Consortium
# All rights reserved.

# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:

#  * Redistributions of source code must retain the above copyright notice,
#    this list of conditions and the following disclaimer.

#  * Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the following disclaimer in the documentation
#    and/or other materials provided with the distribution.

#  * The name of the Insight Consortium, nor the names of any consortium members,
#    nor of any contributors, may be used to endorse or promote products derived
#    from this software without specific prior written permission.

#   * Modified source versions must be plainly marked as such, and must not be
#     misrepresented as being the original software.

# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDER AND CONTRIBUTORS ``AS IS''
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHORS OR CONTRIBUTORS BE LIABLE FOR
# ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.



source Testing/Utilities/Build.conf

source ../Insight/Testing/Utilities/Utility.tcl
cd ../Insight

set Out stdout

puts $Out {<?xml version="1.0" encoding="UTF-8"?>}
puts $Out {<!DOCTYPE Insight>}
puts $Out {<Configure>}
puts $Out "\t<StartDateTime>[clock format [clock seconds]]</StartDateTime>"

if { $CVSCommand != "" } \
{
  catch { exec $CVSCommand -n update >& Configure.log }
}


set In [open Configure.log r]

while { ![eof $In] } \
{
  set Line [gets $In]
  if { [regexp {^[U] } $Line ] > 0 } \
  {
    set file [string trimleft $Line {U }]
    set lastRevision [lindex [exec $CVSCommand log -N -r $file | $GrepCommand "revision "] 1]
    set allRevisions  [exec $CVSCommand log -N -r:$lastRevision $file | $GrepCommand "revision "]
    set priorRevision [lindex $allRevisions 3]
    set Comment [exec $CVSCommand log -N -r $file | $GrepCommand -v "access list:" | $GrepCommand -v "RCS file:" | $GrepCommand -v "Working file:" | $GrepCommand -v "head:" | $GrepCommand -v "branch:" | $GrepCommand -v "locks:" | $GrepCommand -v "keyword substitution:" | $GrepCommand -v "total revisions:" | $GrepCommand -v "description:" | $GrepCommand -v "\\-\\-\\-\\-\\-\\-\\-\\-\\-\\-" | $GrepCommand -v ^$ ]
    set Info [exec $CVSCommand log -N -r $file | grep "date:"]
    set Author [string trim [lindex $Info 4] ";"]
    set Date [string trim [lrange $Info 1 2] ";"]
    set State [string trim [lindex $Info 6] ";"]

    puts $Out "\t<Change>"
    puts $Out "\t\t<Filename>[XMLSafeString $file]</Filename>"
    puts $Out "\t\t<CurrentRevision>[XMLSafeString $lastRevision]</CurrentRevision>"
    puts $Out "\t\t<PriorRevision>[XMLSafeString $priorRevision]</PriorRevision>"
    puts $Out "\t\t<Info>"
    puts $Out "\t\t\t<Author>[XMLSafeString $Author]</Author>"
    puts $Out "\t\t\t<Date>[XMLSafeString $Date]</Date>"
    puts $Out "\t\t\t<State>[XMLSafeString $State]</State>"
    puts $Out "\t\t</Info>"
    puts $Out "\t\t<Comment>"
    puts $Out [XMLSafeString $Comment]
    puts $Out "\t\t</Comment>"
    puts $Out "\t<Change>"
  }
}
  
puts $Out "\t<EndDateTime>[clock format [clock seconds]]</EndDateTime>"

puts $Out "</Configure>"

exit

